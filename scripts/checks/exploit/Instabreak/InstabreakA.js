// @ts-check
import Check from "../../Check.js";
import { world, GameMode } from "@minecraft/server";

/**
 * Before 1.16.210, breaking blocks by the client involved the PlayerAction Packet which did not validate whether a player was actually able to break a block
 * This meant that a malicious client could break every single block instantly, even blocks such as bedrock
 * To prevent this, Mojang implemented Server Authoritative Breaking (SAB), which according to the BDS documentation, "the server will compute block mining operations in sync with the client so it can verify that the client should be able to break blocks when it thinks it can"
 * When Server Authoritative Block Breaking is enabled, the client would instead use the PlayerAuthInput Packet to let the server know that it is breaking a block.
 * This packet is also responsible for validating whether a player's movement is valid by Server Authoritative Movement
 * 
 * Since the server validates how long a player has been breaking a block for, this should mean that instabreak exploits should not affect BDS and this check is completely redundant
 * However it was discovered in the wild that a group of players were able to bypass SAB and destroy bedrock and end portal frames
 * As a remedy, this check was implemented to make sure players who are not in creative cannot break blocks that are unbreakable
 */
class InstabreakA extends Check {
	/**
	 * @class
	 * @description Check for breaking unbreakable blocks while not in Creative
	 */
	constructor() {
		super({
			check: "Instabreak",
			subcheck: "A",
			type: "Exploit"
		});

		if(this.config.enabled) this.enable();
	}

	enable() {
		world.beforeEvents.playerBreakBlock.subscribe(this.beforePlayerBreakBlock.bind(this));
	}

	disable() {
		world.beforeEvents.playerBreakBlock.unsubscribe(this.beforePlayerBreakBlock);
	}

	/**
	 * @param {import("@minecraft/server").PlayerBreakBlockBeforeEvent} data
	 */
	beforePlayerBreakBlock(data) {
		console.log(11);
		const { player, block } = data;
		if(player.getGameMode() === GameMode.Creative) return;

		if(this.config.unbreakable_blocks.includes(block.typeId)) {
			this.delayedFlag(player, `block=${block.typeId}`);
			data.cancel = true;
		}
	}
}

export default new InstabreakA();