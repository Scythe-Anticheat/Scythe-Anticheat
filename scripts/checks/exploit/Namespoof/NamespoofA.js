// @ts-check
import Check from "../../../assets/Check.js";
import { world } from "@minecraft/server";

class NamespoofA extends Check {
	/**
	 * @class
	 * @description Check if a player's name is too long or short
	 */
	constructor() {
		super({
			check: "Namespoof",
			subcheck: "A",
			type: "Exploit"
		});

		if(this.config.enabled) this.enable();
	}

	enable() {
		this.callbacks = {
			afterPlayerSpawn: world.afterEvents.playerSpawn.subscribe(this.afterPlayerSpawn.bind(this))
		};
	}

	disable() {
		if(!this.callbacks) return;

		world.afterEvents.playerSpawn.unsubscribe(this.callbacks.afterPlayerSpawn);
		delete this.callbacks;
	}

	/**
	 * @param {import("@minecraft/server").PlayerSpawnAfterEvent} data
	 */
	afterPlayerSpawn(data) {
		const { initialSpawn, player } = data;
		if(!initialSpawn) return;

		// When a sub-client joins a world their name has a suffix of (x), with x being a number between 1-3.
		// To prevent any false positives with this, we make sure to omit that suffix from being calculated in the length checks
		const maxLength = this.config.maxNameLength + ((/\([1-3]\)$/).test(player.name) ? 3 : 0);

		if(player.name.length < this.config.minNameLength || player.name.length > maxLength) {
			const extraLength = player.name.length - this.config.maxNameLength;
			player.nameTag = player.name.slice(0, -extraLength) + "...";

			this.flag(player, `length=${player.name.length}`);
		}
	}
}

export default new NamespoofA();