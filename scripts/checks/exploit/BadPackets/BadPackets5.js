// @ts-check
import Check from "../../../assets/Check.js";
import { world } from "@minecraft/server";

class BadPackets5 extends Check {
	/**
	 * @class
	 * @description Check for invalid data in the login skindata packet
	 */
	constructor() {
		super({
			check: "BadPackets",
			subcheck: "5",
			type: "Exploit"
		});

		if(this.config.enabled) this.enable();
	}

	enable() {
		this.callbacks = {
			afterPlayerSpawn: world.afterEvents.playerSpawn.subscribe(this.afterPlayerSpawn.bind(this))
		};
	}

	disable() {
		if(!this.callbacks) return;

		world.afterEvents.playerSpawn.unsubscribe(this.callbacks.afterPlayerSpawn);
		delete this.callbacks;
	}

	/**
	 * @param {import("@minecraft/server").PlayerSpawnAfterEvent} data
	 */
	afterPlayerSpawn(data) {
		const { initialSpawn, player } = data;
		if(!initialSpawn) return;

		/*
		Check if the player's max render distance is not inside bounds. Vanilla clients would have this value set to 6-96 according to https://minecraftbedrock-archive.fandom.com/wiki/Render_Distance
		The article is slightly outdated as it is possible for really low-end devices to have a max render distance of 5
		*/
		const renderDistance = player.clientSystemInfo.maxRenderDistance;
		if(renderDistance < 5 || renderDistance > 96) {
			this.flag(player, `maxRenderDistance=${renderDistance}`);
		}
	}
}

export default new BadPackets5();